<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Admin Valentine v2</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Dancing+Script:wght@700&family=Pacifico&family=Montserrat:wght@400;700&family=Great+Vibes&family=Cinzel:wght@700&family=Poppins:wght@300;400;600&family=Cormorant+Garamond:ital,wght@1,600&family=Lobster&family=Sacramento&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        rose: { 50: '#fff1f2', 100: '#ffe4e6', 200: '#fecdd3', 500: '#f43f5e', 600: '#e11d48', 700: '#be123c', 900: '#881337' },
                        cream: '#F5E6D3'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Playfair Display', 'serif']
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            color: #334155;
        }

        .page-card {
            background: white;
            border-radius: 1.5rem;
            padding: 2.5rem;
            margin-bottom: 2.5rem;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .page-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 8px;
            height: 100%;
            background: #cbd5e1;
            transition: background 0.3s ease;
        }

        .page-card:hover {
            border-color: #fda4af;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: translateY(-2px);
        }

        .page-card:hover::before {
            background: #be123c;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .section-icon {
            background: #fff1f2;
            padding: 0.75rem;
            border-radius: 1rem;
            color: #e11d48;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-badge {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: #f1f5f9;
            padding: 0.35rem 1rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 800;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .dynamic-item {
            position: relative;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 1.25rem;
            border-radius: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }

        .dynamic-item:hover {
            border-color: #cbd5e1;
            background: #f1f5f9;
        }

        .remove-btn {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            background: #be123c;
            color: white;
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
            transition: transform 0.2s ease;
        }

        .remove-btn:hover {
            transform: scale(1.1);
            background: #9f1239;
        }

        .form-input {
            width: 100%;
            border-radius: 0.75rem;
            border-color: #e2e8f0;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            border-color: #f43f5e;
            outline: none;
            box-shadow: 0 0 0 3px rgba(254, 205, 211, 0.5);
        }

        .btn-add {
            margin-top: 1rem;
            width: 100%;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            border-width: 2px;
            border-style: dashed;
            border-color: #e2e8f0;
            border-radius: 0.75rem;
            color: #9ca3af;
            font-weight: 700;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-add:hover {
            border-color: #fda4af;
            color: #f43f5e;
            background-color: #fff1f2;
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        #outputCode {
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #111827;
        }

        /* --- NEW LAYOUT: LEFT SIDEBAR FLEXBOX --- */
        .admin-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 3rem;
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 2rem;
            position: relative;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            min-width: 0;
            width: 100%;
        }

        /* Sidebar: Sticky & Fixed Width */
        .sticky-sidebar {
            width: 420px;
            flex-shrink: 0;
            position: sticky;
            top: 110px;
            height: calc(100vh - 140px);
            z-index: 40;
            display: none;
        }

        .sticky-sidebar.force-hidden {
            display: none !important;
        }

        /* Desktop: Show Sidebar */
        @media (min-width: 1024px) {
            .sticky-sidebar {
                display: block;
            }
        }

        /* Mobile: Modal Mode */
        @media (max-width: 1023px) {
            .sticky-sidebar.mobile-open {
                display: flex;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                z-index: 2000;
                background: rgba(0, 0, 0, 0.9);
                align-items: center;
                justify-content: center;
                padding: 20px;
                backdrop-filter: blur(5px);
            }
        }

        /* Smartphone Frame Styling */
        .smartphone-frame {
            width: 100%;
            height: 100%;
            max-height: 820px;
            background: #111;
            border-radius: 2rem;
            border: 8px solid #222;
            box-shadow: 0 20px 60px -10px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .smartphone-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 20px;
            background: #222;
            border-bottom-left-radius: 1rem;
            border-bottom-right-radius: 1rem;
            z-index: 20;
        }

        .preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            border-radius: 2rem;
        }

        .img-preview-mini {
            width: 48px;
            height: 48px;
            border-radius: 0.5rem;
            object-fit: cover;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            transition: transform 0.2s ease;
        }

        .img-preview-mini:hover {
            transform: scale(3);
            transform-origin: center right;
            z-index: 50;
            position: relative;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* --- SUBTLE HINT BUTTON --- */
        .btn-hint {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            color: #64748b;
            font-size: 0.65rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            transition: all 0.2s ease;
        }

        .btn-hint:hover {
            background: #fff1f2;
            color: #be123c;
            border-color: #fecdd3;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .btn-hint span {
            font-size: 1.1rem !important;
        }
    </style>
</head>

<body class="">



    <!-- Header Area -->
    <header class="glass-header sticky top-0 z-40 mb-12">
        <div class="max-w-6xl mx-auto px-6 py-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-display italic font-bold text-gray-900 leading-none flex items-center gap-3">
                    Valentine Configurator
                    <span id="syncStatus"
                        class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 text-[10px] font-sans font-bold text-slate-400 uppercase tracking-tighter transition-all">
                        <span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span> Disconnected
                    </span>
                </h1>
                <p class="text-sm text-gray-500 mt-1 font-sans">Level up your gift: Create `data.js` with style.</p>
            </div>
            <div class="flex gap-4">
                <button onclick="togglePreview()"
                    class="bg-white text-gray-700 px-6 py-3.5 rounded-2xl font-bold border border-gray-200 hover:bg-gray-50 flex items-center gap-2 shadow-sm transition-all">
                    <span class="material-symbols-outlined text-rose-500">smartphone</span> PREVIEW
                </button>
                <button onclick="syncToPreview()"
                    class="bg-white text-gray-700 p-3.5 rounded-2xl font-bold border border-gray-200 hover:bg-gray-50 flex items-center justify-center shadow-sm transition-all"
                    title="Refresh Preview">
                    <span class="material-symbols-outlined text-indigo-500">refresh</span>
                </button>
                <button onclick="generateCode()"
                    class="bg-rose-100 text-rose-700 px-6 py-3.5 rounded-2xl font-bold hover:bg-rose-200 flex items-center gap-2 shadow-sm transition-all">
                    <span class="material-symbols-outlined text-lg">code</span> View Code
                </button>
                <button onclick="submitToAdmin()"
                    class="bg-rose-600 text-white px-8 py-3.5 rounded-2xl font-bold hover:bg-rose-700 flex items-center gap-2 shadow-xl shadow-rose-200 hover:scale-[1.02] active:scale-[0.98] transition-all">
                    <span class="material-symbols-outlined">send</span> FINISH & SEND TO ADMIN
                </button>
            </div>
        </div>
    </header>

    <!-- FLEXBOX WRAPPER (sidebar on left) -->
    <div class="admin-wrapper">

        <!-- LEFT: STICKY PREVIEW -->
        <aside class="sticky-sidebar">
            <div class="smartphone-frame">
                <div class="smartphone-notch"></div>
                <iframe id="livePreview" src="index.html" class="preview-iframe"></iframe>
            </div>
        </aside>

        <!-- RIGHT: FORM CONTENT -->
        <main class="main-content">
            <form id="configForm" onsubmit="return false;">

                <!-- 0. THEME SETTINGS -->
                <div class="page-card bg-gradient-to-br from-indigo-50/50 to-rose-50/50 border-2 border-indigo-100">
                    <div class="section-header">
                        <span
                            class="material-symbols-outlined section-icon !bg-indigo-100 !text-indigo-600">palette</span>
                        <div class="flex-1">
                            <h2 class="text-2xl font-bold text-gray-800">Theme Aesthetics</h2>
                            <p class="text-xs text-indigo-500 font-bold uppercase tracking-widest mt-0.5">Preset &
                                Custom
                                Styling</p>
                        </div>
                    </div>

                    <!-- Quick Presets -->
                    <div class="mb-8 p-4 bg-white/50 rounded-2xl border border-indigo-100">
                        <label class="block text-xs font-bold text-indigo-400 uppercase tracking-widest mb-3">Quick
                            Presets
                            (SaaS Ready)</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <button onclick="applyThemePreset('vintage')"
                                class="px-4 py-3 rounded-xl border-2 border-amber-200 bg-amber-50 text-amber-900 font-bold hover:bg-amber-100 transition-all flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">history_edu</span> Vintage
                            </button>
                            <button onclick="applyThemePreset('midnight')"
                                class="px-4 py-3 rounded-xl border-2 border-slate-700 bg-slate-900 text-slate-100 font-bold hover:bg-slate-800 transition-all flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">dark_mode</span> Midnight
                            </button>
                            <button onclick="applyThemePreset('cute')"
                                class="px-4 py-3 rounded-xl border-2 border-rose-200 bg-rose-50 text-rose-700 font-bold hover:bg-rose-100 transition-all flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">favorite</span> Cute
                            </button>
                            <button onclick="applyThemePreset('modern')"
                                class="px-4 py-3 rounded-xl border-2 border-blue-100 bg-white text-blue-900 font-bold hover:bg-blue-50 transition-all flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">auto_awesome</span> Modern
                            </button>
                            <button onclick="applyThemePreset('sakura')"
                                class="px-4 py-3 rounded-xl border-2 border-pink-100 bg-pink-50 text-pink-700 font-bold hover:bg-pink-100 transition-all flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">local_florist</span> Sakura
                            </button>
                            <button onclick="applyThemePreset('forest')"
                                class="px-4 py-3 rounded-xl border-2 border-emerald-800 bg-emerald-900 text-emerald-50 font-bold hover:bg-emerald-800 transition-all flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">park</span> Forest
                            </button>
                            <button onclick="applyThemePreset('ocean')"
                                class="px-4 py-3 rounded-xl border-2 border-sky-200 bg-sky-50 text-sky-800 font-bold hover:bg-sky-100 transition-all flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">waves</span> Ocean
                            </button>
                            <button onclick="applyThemePreset('sunset')"
                                class="px-4 py-3 rounded-xl border-2 border-orange-200 bg-orange-50 text-orange-900 font-bold hover:bg-orange-100 transition-all flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">wb_twilight</span> Sunset
                            </button>
                            <button onclick="applyThemePreset('royal')"
                                class="px-4 py-3 rounded-xl border-2 border-indigo-200 bg-indigo-50 text-indigo-900 font-bold hover:bg-indigo-100 transition-all flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">universal_currency_alt</span> Royal
                            </button>
                            <button onclick="applyThemePreset('coffee')"
                                class="px-4 py-3 rounded-xl border-2 border-stone-300 bg-stone-100 text-stone-900 font-bold hover:bg-stone-200 transition-all flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">coffee</span> Coffee
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-2">Custom Background Image</label>
                            <div class="flex gap-2 items-center">
                                <img id="prev_theme_bg" src="" class="img-preview-mini hidden">
                                <input type="text" id="theme_bg" class="form-input"
                                    placeholder="assets/bg.png or Leave empty for default craft paper" value=""
                                    oninput="updatePreview('prev_theme_bg', this.value)">
                                <label
                                    class="cursor-pointer bg-white border border-gray-200 rounded-xl px-4 flex items-center hover:bg-gray-50 transition-colors shadow-sm self-stretch">
                                    <span class="material-symbols-outlined text-gray-500">upload_file</span>
                                    <input type="file" class="hidden" accept="image/*"
                                        onchange="handleMediaUpload(this, 'theme_bg')">
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-2">Fallback Background Color</label>
                            <div class="flex gap-2">
                                <input type="color" id="theme_color_picker" class="w-12 h-11 rounded-lg border-gray-200"
                                    value="#F5E6D3" oninput="document.getElementById('theme_color').value = this.value">
                                <input type="text" id="theme_color" class="form-input" value="#F5E6D3">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-2">Primary Font (Main Titles)</label>
                            <select id="theme_font_display" class="form-input">
                                <option value="Playfair Display, serif">Playfair Display (Vintage)</option>
                                <option value="Great Vibes, cursive">Great Vibes (Romantic & Flowy)</option>
                                <option value="Dancing Script, cursive">Dancing Script (Elegant Script)</option>
                                <option value="Sacramento, cursive">Sacramento (Thin & Minimalist)</option>
                                <option value="Cinzel, serif">Cinzel (Luxury / Classic)</option>
                                <option value="Lobster, cursive">Lobster (Retro / Fun)</option>
                                <option value="Pacifico, cursive">Pacifico (Playful)</option>
                                <option value="Montserrat, sans-serif">Montserrat (Bold Modern)</option>
                                <option value="Inter, sans-serif">Inter (Clean)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-2">Secondary Font (Body Text)</label>
                            <select id="theme_font_sans" class="form-input">
                                <option value="Poppins, sans-serif">Poppins (Smooth & Modern)</option>
                                <option value="Inter, sans-serif">Inter (Standard)</option>
                                <option value="Cormorant Garamond, serif">Cormorant Garamond (Fine Italic)</option>
                                <option value="Roboto, sans-serif">Roboto (Clean)</option>
                                <option value="Courier New, monospace">Courier New (Old School)</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-600 mb-2">Atmospheric Particle
                                Effect</label>
                            <select id="theme_particles" class="form-input">
                                <option value="none">None (Clean)</option>
                                <option value="hearts">Hearts & Petals (Romantic / Cute)</option>
                                <option value="stars">Twinkling Stars (Midnight / Magic)</option>
                                <option value="dust">Vintage Dust (Nostalgic / Paper)</option>
                                <option value="bubbles">Floating Bubbles (Modern / Dreamy)</option>
                            </select>
                            <p class="text-[10px] text-gray-400 mt-2 italic">Note: Keep it subtle. These float gently in
                                the
                                background.</p>
                        </div>
                    </div>
                </div>

                <!-- 0.1 SEO & SOCIAL PREVIEW -->
                <div class="page-card border-2 border-emerald-100 bg-emerald-50/20">
                    <div class="section-header">
                        <span
                            class="material-symbols-outlined section-icon !bg-emerald-100 !text-emerald-600">public</span>
                        <div class="flex-1">
                            <h2 class="text-xl font-bold text-gray-800">SEO & Social Preview</h2>
                            <p class="text-[10px] text-emerald-500 font-bold uppercase tracking-widest mt-0.5">WhatsApp
                                / IG
                                / Share Preview</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-2">Site Title (Meta Title)</label>
                            <input type="text" id="seo_title" class="form-input"
                                value="Valentine Login - Key to My Heart"
                                placeholder="e.g. A Special Surprise for [Name]">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-2">Site Description (Meta
                                Desc)</label>
                            <input type="text" id="seo_desc" class="form-input"
                                value="A collection of our best moments."
                                placeholder="e.g. Open this only if you love me!">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-600 mb-2">Social Share Image (OG
                                Image)</label>
                            <div class="flex gap-2 items-center">
                                <img id="prev_seo_image" src="" class="img-preview-mini hidden">
                                <input type="text" id="seo_image" class="form-input"
                                    placeholder="URL to your sharing thumbnail"
                                    value="https://lh3.googleusercontent.com/..."
                                    oninput="updatePreview('prev_seo_image', this.value)">
                                <label
                                    class="cursor-pointer bg-white border border-gray-200 rounded-xl px-4 flex items-center hover:bg-gray-50 transition-colors shadow-sm self-stretch">
                                    <span class="material-symbols-outlined text-gray-500">upload_file</span>
                                    <input type="file" class="hidden" accept="image/*"
                                        onchange="handleMediaUpload(this, 'seo_image')">
                                </label>
                            </div>
                            <p class="text-[10px] text-gray-400 mt-2 italic">Recommendation: Use a 1200x630px image for
                                best
                                results on IG/WA.</p>
                        </div>
                    </div>
                </div>

                <!-- 1. LOGIN & COUNTDOWN -->
                <div class="page-card transition-all duration-300">
                    <span class="page-badge">PAGE 1</span>
                    <div class="section-header flex justify-between items-center mt-4">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined section-icon">lock_person</span>
                            <h2 class="text-xl font-bold">Entry & Countdown</h2>
                        </div>
                        <button onclick="syncPreviewToPage('page-1')" class="btn-hint" title="Sync Preview">
                            <span class="material-symbols-outlined">visibility</span>
                            Lihat di HP
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 font-bold">Secret
                                Password</label>
                            <input type="text" id="password" class="form-input" value="cintaislam1234512345">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 font-bold">Collection
                                Subtitle</label>
                            <input type="text" id="collectionText" class="form-input" value="For you, Always">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 font-bold">Main Title</label>
                            <input type="text" id="p1_title" class="form-input" value="Key to My Heart">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 font-bold">Instruction
                                Hint</label>
                            <input type="text" id="p1_instr" class="form-input" value="Enter the secret password">
                        </div>
                        <div
                            class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6 p-4 bg-rose-50 rounded-2xl border border-rose-100">
                            <div>
                                <label class="block text-sm font-bold text-rose-800 mb-1">Target Date (Count
                                    to...)</label>
                                <input type="datetime-local" id="count_date" class="form-input border-rose-200"
                                    value="2026-02-14T22:00">
                                <p class="text-[10px] text-rose-400 mt-1">Automatically converted to ISO format.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-rose-800 mb-1">Finish Message</label>
                                <input type="text" id="count_finish" class="form-input border-rose-200"
                                    value="It's Time! â¤ï¸">
                            </div>
                        </div>

                        <!-- NEW: Global Navigation Settings -->
                        <div
                            class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6 p-4 bg-indigo-50 rounded-2xl border border-indigo-100 mt-4">
                            <div class="flex items-center justify-between p-2">
                                <div>
                                    <label class="block text-sm font-bold text-indigo-900">Show Page Indicator</label>
                                    <p class="text-[10px] text-indigo-400 font-medium">Show "3/9" at the top center</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="show_indicator" class="sr-only peer" checked>
                                    <div
                                        class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                                    </div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between p-2">
                                <div>
                                    <label class="block text-sm font-bold text-indigo-900">Enable Mobile Swipe</label>
                                    <p class="text-[10px] text-indigo-400 font-medium">Allow swiping left/right to
                                        navigate</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="enable_swipe" class="sr-only peer" checked>
                                    <div
                                        class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. GREETING CARD -->
                <div class="page-card transition-all duration-300">
                    <span class="page-badge">PAGE 2</span>
                    <div class="section-header flex justify-between items-center mt-4">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined section-icon text-pink-500">favorite</span>
                            <h2 class="text-xl font-bold font-display italic">Greeting Card</h2>
                        </div>
                        <button onclick="syncPreviewToPage('page-2')" class="btn-hint" title="Sync Preview">
                            <span class="material-symbols-outlined">visibility</span>
                            Lihat di HP
                        </button>
                    </div>
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-bold text-gray-600 mb-1">Card Hero Title</label>
                                <input type="text" id="greet_title" class="form-input" value="Happy Valentineâ€™s Day">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-bold text-gray-600 mb-1">Personal Message</label>
                                <textarea id="greet_msg" class="form-input"
                                    rows="3">I made this little archive to celebrate us. A collection of moments, secrets, and reasons why I love you.</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-600 mb-1">Hero Image</label>
                                <div class="flex gap-2 items-center">
                                    <img id="prev_greet_img" src="" class="img-preview-mini hidden">
                                    <input type="text" id="greet_img" class="form-input"
                                        value="https://lh3.googleusercontent.com/..."
                                        oninput="updatePreview('prev_greet_img', this.value)">
                                    <label
                                        class="cursor-pointer bg-white border border-gray-200 rounded-xl px-4 flex items-center hover:bg-gray-50 shadow-sm transition-colors self-stretch">
                                        <span class="material-symbols-outlined text-gray-400">add_photo_alternate</span>
                                        <input type="file" class="hidden" accept="image/*"
                                            onchange="handleMediaUpload(this, 'greet_img')">
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-600 mb-1">Footer Tagline</label>
                                <input type="text" id="greet_footer" class="form-input" value="For you, Always">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. DYNAMIC SECTIONS (Music, etc.) -->
                <div id="pages-container"></div>

                <!-- DYNAMIC ADD BUTTON -->
                <div class="flex justify-center my-8">
                    <button onclick="openPagePicker()"
                        class="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-bold shadow-xl shadow-indigo-200 hover:scale-105 active:scale-95 transition-all flex items-center gap-3">
                        <span class="material-symbols-outlined">add_circle</span> Add New Section
                    </button>
                </div>
    </div>

    </form>
    </main>
    </div> <!-- /.admin-wrapper -->




    <!-- GENERATED CODE MODAL -->
    <div id="resultModal"
        class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[100] animate-fade-in">
        <div
            class="bg-gray-900 border border-gray-800 rounded-3xl w-full max-w-5xl max-h-[90vh] flex flex-col p-8 shadow-2xl relative">
            <button onclick="document.getElementById('resultModal').classList.add('hidden')"
                class="absolute -top-4 -right-4 bg-white text-black p-2 rounded-full hover:scale-110 active:scale-90 transition-transform shadow-xl">
                <span class="material-symbols-outlined">close</span>
            </button>
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                        <span class="material-symbols-outlined text-green-400">check_circle</span>
                        Config Generated!
                    </h2>
                    <p class="text-gray-400 text-sm mt-1">Copy the code below and replace everything in your <code
                            class="bg-gray-800 px-2 py-0.5 rounded text-rose-400 italic">data.js</code> file.</p>
                </div>
            </div>

            <div class="relative flex-grow group">
                <textarea id="outputCode"
                    class="w-full h-full font-mono text-sm bg-black text-emerald-400 p-6 rounded-2xl border border-gray-800 focus:ring-0 resize-none outline-none leading-relaxed"
                    readonly></textarea>
                <div class="absolute bottom-4 right-4 flex gap-2">
                    <button onclick="copyCode()"
                        class="bg-emerald-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-emerald-600 shadow-lg shadow-emerald-500/20 active:scale-95 transition-all flex items-center gap-2">
                        <span class="material-symbols-outlined">content_copy</span> Copy Code
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Floating Toggle Button -->
    <div class="fixed bottom-6 right-6 z-50">
        <button onclick="togglePreview()"
            class="bg-gray-900 text-white p-4 rounded-full shadow-2xl hover:scale-110 active:scale-90 transition-transform flex items-center justify-center border border-gray-700">
            <span class="material-symbols-outlined text-rose-400">smartphone</span>
        </button>
    </div>

    <script>
        // --- LIVE PREVIEW SYNC ---
        let syncTimeout;

        function syncPreviewToPage(pageId) {
            console.log(`ðŸ“¡ Manual Sync: Scrolling to ${pageId}`);
            const iframe = document.getElementById('livePreview');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({
                    type: 'NAVIGATE_TO_PAGE',
                    pageId: pageId
                }, '*');
            }
        }

        // --- DATA STATE (Config Data is initialized in initProject/DOMContentLoaded) ---

        // --- NEW: THEME PRESETS ---
        function applyThemePreset(theme) {
            const presets = {
                vintage: {
                    bg: "",
                    color: "#F5E6D3",
                    fontDisplay: "Playfair Display, serif",
                    fontSans: "Inter, sans-serif",
                    particles: "dust"
                },
                midnight: {
                    bg: "https://images.unsplash.com/photo-1534796633326-59fdb124f2b3?q=80&w=2070&auto=format&fit=crop",
                    color: "#0f172a",
                    fontDisplay: "Dancing Script, cursive",
                    fontSans: "Inter, sans-serif",
                    particles: "stars"
                },
                cute: {
                    bg: "",
                    color: "#fff1f2",
                    fontDisplay: "Pacifico, cursive",
                    fontSans: "Inter, sans-serif",
                    particles: "hearts"
                },
                modern: {
                    bg: "https://images.unsplash.com/photo-1483730120419-9067de06d2c4?q=80&w=2076&auto=format&fit=crop",
                    color: "#ffffff",
                    fontDisplay: "Montserrat, sans-serif",
                    fontSans: "Inter, sans-serif",
                    particles: "bubbles"
                },
                sakura: {
                    bg: "https://images.unsplash.com/photo-1522383225653-ed111181a951?q=80&w=2070&auto=format&fit=crop",
                    color: "#fff1f2",
                    fontDisplay: "Dancing Script, cursive",
                    fontSans: "Inter, sans-serif",
                    particles: "hearts"
                },
                forest: {
                    bg: "https://images.unsplash.com/photo-1511497584788-876760111969?q=80&w=2070&auto=format&fit=crop",
                    color: "#064e3b",
                    fontDisplay: "Lora, serif",
                    fontSans: "Inter, sans-serif",
                    particles: "dust"
                },
                ocean: {
                    bg: "https://images.unsplash.com/photo-1459411552884-841db9b3cc2a?q=80&w=2070&auto=format&fit=crop",
                    color: "#0c4a6e",
                    fontDisplay: "Montserrat, sans-serif",
                    fontSans: "Inter, sans-serif",
                    particles: "bubbles"
                },
                sunset: {
                    bg: "https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=2070&auto=format&fit=crop",
                    color: "#FDE68A",
                    fontDisplay: "Pacifico, cursive",
                    fontSans: "Inter, sans-serif",
                    particles: "stars"
                },
                royal: {
                    bg: "https://images.unsplash.com/photo-1542314831-068cd1dbfeeb?q=80&w=2070&auto=format&fit=crop",
                    color: "#1e1b4b",
                    fontDisplay: "Playfair Display, serif",
                    fontSans: "Inter, sans-serif",
                    particles: "stars"
                },
                coffee: {
                    bg: "https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?q=80&w=2070&auto=format&fit=crop",
                    color: "#f5f5f4",
                    fontDisplay: "Playfair Display, serif",
                    fontSans: "Inter, sans-serif",
                    particles: "dust"
                }
            };

            const data = presets[theme];
            if (!data) return;

            // Set values
            document.getElementById('theme_bg').value = data.bg;
            document.getElementById('theme_color').value = data.color;
            document.getElementById('theme_color_picker').value = data.color;
            document.getElementById('theme_font_display').value = data.fontDisplay;
            document.getElementById('theme_font_sans').value = data.fontSans;
            document.getElementById('theme_particles').value = data.particles || 'none';

            // Visual feedback on the button
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="material-symbols-outlined text-sm">done</span> Applied!';
            setTimeout(() => { btn.innerHTML = originalText; }, 1500);

            syncToPreview();
        }

        // --- HELPERS (Removed Legacy Sync) ---

        // ============================================
        // CLOUDFLARE UPLOAD INTEGRATION
        // ============================================

        // ðŸ‘‡ GANTI INI DENGAN URL WORKER ANDA!
        const UPLOAD_API_URL = 'https://valentine-upload.aldoramadhan16.workers.dev/upload';

        async function uploadToCloud(file, onProgress) {
            try {
                const allowedTypes = {
                    'audio': ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/x-m4a'],
                    'video': ['video/mp4', 'video/webm', 'video/quicktime'],
                    'image': ['image/jpeg', 'image/png', 'image/gif', 'image/webp']
                };

                let fileType = 'other';
                for (const [type, mimes] of Object.entries(allowedTypes)) {
                    if (mimes.some(mime => file.type === mime || file.name.toLowerCase().endsWith(mime.split('/')[1]))) {
                        fileType = type;
                        break;
                    }
                }

                if (fileType === 'other') {
                    throw new Error('File type not supported. Please upload MP3, MP4, or image files.');
                }

                const maxSize = 100 * 1024 * 1024;
                if (file.size > maxSize) {
                    throw new Error('File too large. Maximum size is 100MB.');
                }

                const formData = new FormData();
                formData.append('file', file);

                showUploadProgress(file.name, 0);

                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();

                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const percent = (e.loaded / e.total) * 100;
                            showUploadProgress(file.name, percent);
                            if (onProgress) onProgress(percent);
                        }
                    });

                    xhr.addEventListener('load', () => {
                        hideUploadProgress();
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                if (response.success) {
                                    resolve(response.url);
                                } else {
                                    reject(new Error(response.error || 'Upload failed'));
                                }
                            } catch (e) {
                                reject(new Error('Invalid server response'));
                            }
                        } else {
                            reject(new Error(`Upload failed with status ${xhr.status}`));
                        }
                    });

                    xhr.addEventListener('error', () => {
                        hideUploadProgress();
                        reject(new Error('Network error during upload'));
                    });

                    xhr.open('POST', UPLOAD_API_URL);
                    xhr.send(formData);
                });
            } catch (error) {
                hideUploadProgress();
                throw error;
            }
        }

        function showUploadProgress(filename, percent) {
            let modal = document.getElementById('upload-progress-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'upload-progress-modal';
                modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[200]';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="material-symbols-outlined text-blue-500 text-3xl animate-spin">cloud_upload</span>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Uploading File...</h3>
                                <p class="text-xs text-gray-500">Please wait</p>
                            </div>
                        </div>
                        <p id="upload-filename" class="text-sm text-gray-600 mb-4 truncate"></p>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div id="upload-progress-bar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="upload-percent" class="text-center text-sm font-bold text-gray-700 mt-2">0%</p>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            modal.classList.remove('hidden');
            document.getElementById('upload-filename').textContent = filename;
            document.getElementById('upload-progress-bar').style.width = Math.round(percent) + '%';
            document.getElementById('upload-percent').textContent = Math.round(percent) + '%';
        }

        function hideUploadProgress() {
            const modal = document.getElementById('upload-progress-modal');
            if (modal) setTimeout(() => modal.classList.add('hidden'), 500);
        }

        async function handleMediaUpload(input, targetInputId) {
            let file = input.files[0];
            if (!file) return;
            const targetInput = document.getElementById(targetInputId);
            if (!targetInput) { alert('Error: Target input not found'); return; }
            const uploadBtn = input.parentElement;
            const originalHtml = uploadBtn.innerHTML;
            try {
                uploadBtn.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span>';
                uploadBtn.classList.add('opacity-50', 'pointer-events-none');

                // Compression logic for images (excluding GIFs to preserve animation)
                if (file.type.startsWith('image/') && !file.type.includes('gif')) {
                    try {
                        const compressedBlob = await compressImage(file);
                        file = new File([compressedBlob], file.name, { type: file.type });
                    } catch (e) {
                        console.warn("Compression failed, using original file", e);
                    }
                }

                const cloudUrl = await uploadToCloud(file);
                targetInput.value = cloudUrl;
                targetInput.dispatchEvent(new Event('input', { bubbles: true }));

                // Refresh preview if exists
                const previewImg = uploadBtn.parentElement.querySelector('img, video, .img-preview-mini');
                if (previewImg) {
                    previewImg.src = cloudUrl;
                    previewImg.classList.remove('hidden');
                    if (previewImg.tagName === 'VIDEO') {
                        previewImg.muted = true;
                        previewImg.play().catch(e => console.warn("Video preview auto-play failed", e));
                    }
                }

                uploadBtn.innerHTML = '<span class="material-symbols-outlined text-green-500">check_circle</span>';
                uploadBtn.classList.remove('opacity-50', 'pointer-events-none');
                showToast('âœ… Upload successful!', 'success');
                setTimeout(() => uploadBtn.innerHTML = originalHtml, 2000);
                syncToPreview();
            } catch (err) {
                console.error('Upload failed:', err);
                uploadBtn.innerHTML = originalHtml;
                uploadBtn.classList.remove('opacity-50', 'pointer-events-none');
                showToast(err.message || 'âŒ Upload failed', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-[300] px-6 py-3 rounded-lg shadow-lg text-white font-medium transform transition-all duration-300 ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`;
            toast.textContent = message;
            toast.style.transform = 'translateX(400px)';
            document.body.appendChild(toast);
            setTimeout(() => toast.style.transform = 'translateX(0)', 10);
            setTimeout(() => { toast.style.transform = 'translateX(400px)'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // --- IMAGE COMPRESSION WORKER (OFF-MAIN-THREAD) ---
        const compressionWorkerCode = `
            self.onmessage = async (e) => {
                const { file, maxWidth, maxHeight, quality } = e.data;
                
                try {
                    const bitmap = await createImageBitmap(file);
                    let width = bitmap.width;
                    let height = bitmap.height;

                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    const canvas = new OffscreenCanvas(width, height);
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(bitmap, 0, 0, width, height);

                    // Standardize on WebP for compression. 
                    // It's much smaller than PNG/JPEG and supports transparency.
                    const type = 'image/webp'; 
                    const blob = await canvas.convertToBlob({
                        type: type,
                        quality: quality
                    });

                    self.postMessage({ blob: blob, success: true });
                } catch (err) {
                    self.postMessage({ error: err.message, success: false });
                }
            };
        `;

        const workerBlob = new Blob([compressionWorkerCode], { type: 'application/javascript' });
        const workerUrl = URL.createObjectURL(workerBlob);
        const compressionWorker = new Worker(workerUrl);

        async function compressImage(file, { maxWidth = 1200, maxHeight = 1200, quality = 0.7 } = {}) {
            return new Promise((resolve, reject) => {
                const onMessage = (e) => {
                    compressionWorker.removeEventListener('message', onMessage);
                    if (e.data.success) {
                        resolve(e.data.blob);
                    } else {
                        reject(e.data.error);
                    }
                };
                compressionWorker.addEventListener('message', onMessage);
                compressionWorker.postMessage({ file, maxWidth, maxHeight, quality });
            });
        }

        async function uploadImage(input, targetId) {
            const file = input.files[0];
            if (!file) return;

            // Visual feedback
            const labelBtn = input.parentElement;
            const originalHtml = labelBtn.innerHTML;
            labelBtn.innerHTML = '<span class="material-symbols-outlined animate-spin text-gray-500">progress_activity</span>';
            labelBtn.classList.add('pointer-events-none', 'opacity-70');

            try {
                const compressedBase64 = await compressImage(file);
                document.getElementById(targetId).value = compressedBase64;
                updatePreview(`prev_${targetId}`, compressedBase64);
                syncToPreview();
            } catch (err) {
                console.error("Compression failed", err);
                alert("Failed to process image: " + err);
            } finally {
                labelBtn.innerHTML = originalHtml;
                labelBtn.classList.remove('pointer-events-none', 'opacity-70');
            }
        }

        async function uploadDynamicImage(input) {
            const file = input.files[0];
            if (!file) return;

            const textInput = input.parentElement.previousElementSibling;
            if (textInput && (textInput.tagName === 'INPUT' || textInput.tagName === 'TEXTAREA')) {
                // Visual feedback
                const labelBtn = input.parentElement;
                const originalHtml = labelBtn.innerHTML;
                labelBtn.innerHTML = '<span class="material-symbols-outlined animate-spin text-gray-400">progress_activity</span>';
                labelBtn.classList.add('pointer-events-none', 'opacity-70');

                try {
                    const compressedBase64 = await compressImage(file);
                    textInput.value = compressedBase64;
                    // Important: Manually trigger the input event so configData is updated
                    textInput.dispatchEvent(new Event('input', { bubbles: true }));
                    // Find preview within the same group
                    const previewImg = labelBtn.parentElement.querySelector('.img-preview-mini');
                    if (previewImg) {
                        previewImg.src = compressedBase64;
                        previewImg.classList.remove('hidden');
                    }
                    syncToPreview();
                } catch (err) {
                    console.error("Compression failed", err);
                    alert("Failed to process image.");
                } finally {
                    labelBtn.innerHTML = originalHtml;
                    labelBtn.classList.remove('pointer-events-none', 'opacity-70');
                }
            }
        }

        // --- PREVIEW HELPER ---
        function updatePreview(imgId, value) {
            const img = document.getElementById(imgId);
            if (!img) return;
            if (value && value.trim() !== '') {
                img.src = value;
                img.classList.remove('hidden');
            } else {
                img.classList.add('hidden');
            }
        }

        // --- RENDERERS (Removed Legacy) ---

        // --- INITIALIZE ALL REMOVED (Moved to DOMContentLoaded) ---


        // --- DYNAMIC ENGINE (PHASE 1) ---
        let configData = {
            pages: []
        };

        const PAGE_TYPES = {
            'music-section': {
                icon: 'library_music',
                fields: [
                    { key: 'songTitle', label: 'Section Label', type: 'text' },
                    { key: 'music', label: 'Playlist', type: 'list', itemType: 'song' }
                ]
            },
            'quiz-section': {
                icon: 'psychology',
                fields: [
                    { key: 'title', label: 'Quiz Title', type: 'text' },
                    { key: 'questions', label: 'Questions', type: 'list', itemType: 'question' }
                ]
            },
            'gallery-section': {
                icon: 'photo_library',
                fields: [
                    { key: 'title', label: 'Gallery Title', type: 'text' },
                    { key: 'subtitle', label: 'Subtitle', type: 'text' },
                    { key: 'memories', label: 'Photos / Videos', type: 'list', itemType: 'memory' }
                ]
            },
            'wrapped-section': {
                icon: 'print',
                fields: [
                    { key: 'vibeLabel', label: 'Vibe Label', type: 'text' },
                    { key: 'vibe', label: 'Vibe Status', type: 'text' },
                    { key: 'HoursTogetherLabel', label: 'Time Label', type: 'text' },
                    { key: 'HoursTogether', label: 'Time Amount', type: 'text' },
                    { key: 'imageSrc', label: 'Hero Image', type: 'image' },
                    { key: 'topPlacesLabel', label: 'Places Title', type: 'text' },
                    { key: 'topPlaces', label: 'Top Places List', type: 'list-simple' },
                    { key: 'coreMemoriesLabel', label: 'Memories Title', type: 'text' },
                    { key: 'coreMemories', label: 'Core Memories List', type: 'list-simple' }
                ]
            },
            'map-section': {
                icon: 'map',
                fields: [
                    { key: 'title', label: 'Map Title', type: 'text' },
                    { key: 'description', label: 'Map Description', type: 'text' },
                    { key: 'locations', label: 'Locations', type: 'list', itemType: 'location' }
                ]
            },
            'letter-section': {
                icon: 'mail',
                fields: [
                    { key: 'recipient', label: 'Recipient Name', type: 'text' },
                    { key: 'message', label: 'Your Letter', type: 'textarea' },
                    { key: 'signature', label: 'Signature', type: 'text' }
                ]
            },
            'lock-section': {
                icon: 'lock_open',
                fields: [
                    { key: 'initials', label: 'Lock Initials (e.g. A + B)', type: 'text' },
                    { key: 'instruction', label: 'Instruction Text', type: 'text' },
                    { key: 'finalMessage', label: 'Final Message', type: 'textarea' }
                ]
            },
            'invitation-section': {
                icon: 'auto_awesome',
                fields: [
                    { key: 'title', label: 'Question', type: 'text' },
                    { key: 'subtitle', label: 'Subtitle', type: 'text' },
                    { key: 'yesText', label: 'Yes Button', type: 'text' },
                    { key: 'noText', label: 'No Button', type: 'text' }
                ]
            }
        };

        function renderPages() {
            const container = document.getElementById('pages-container');
            if (!container) return;
            container.innerHTML = '';

            configData.pages.forEach((page, index) => {
                const uniqueId = `p${index}`;
                const typeInfo = PAGE_TYPES[page.type];

                const pageEl = document.createElement('div');
                pageEl.className = 'page-card relative group border-l-4 border-indigo-500 transition-all duration-300 mb-6';

                let fieldsHtml = '';
                typeInfo.fields.forEach(field => {
                    const fieldId = `${uniqueId}-${field.key}`;
                    fieldsHtml += renderField(field, page[field.key], (newVal) => {
                        configData.pages[index][field.key] = newVal;
                        syncToPreview();
                    }, fieldId);
                });

                // MAPPING ENGINE: Dynamic indexing based on column position
                let actualPageId = `page-${index + 3}`;
                let displayNum = index + 3;

                pageEl.innerHTML = `
                    <span class="page-badge">PAGE ${displayNum}</span>
                    <div class="section-header flex justify-between items-center mt-4">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined section-icon !bg-indigo-100 !text-indigo-600">${typeInfo.icon}</span>
                            <h2 class="text-xl font-bold capitalize">${page.type.replace('-', ' ')}</h2>
                        </div>
                        <div class="flex items-center gap-2">
                             <button onclick="syncPreviewToPage('${actualPageId}')" class="btn-hint" title="Sync Preview">
                                <span class="material-symbols-outlined">visibility</span>
                                Lihat di HP
                             </button>
                             <div class="w-px h-6 bg-slate-200 mx-2"></div>
                             <div class="flex items-center gap-1">
                                <button onclick="movePage(${index}, -1)" class="p-1.5 text-slate-400 hover:text-indigo-600 ${index === 0 ? 'opacity-20 pointer-events-none' : ''}"><span class="material-symbols-outlined text-sm">arrow_upward</span></button>
                                <button onclick="movePage(${index}, 1)" class="p-1.5 text-slate-400 hover:text-indigo-600 ${index === configData.pages.length - 1 ? 'opacity-20 pointer-events-none' : ''}"><span class="material-symbols-outlined text-sm">arrow_downward</span></button>
                             </div>
                             <div class="w-px h-6 bg-slate-200 mx-2"></div>
                             <button onclick="removePage(${index})" class="text-rose-400 hover:text-rose-600 p-1.5">
                                <span class="material-symbols-outlined text-sm">delete</span>
                             </button>
                        </div>
                    </div>
                    <div class="space-y-6">
                        ${fieldsHtml}
                    </div>
                `;
                container.appendChild(pageEl);
            });
        }

        function renderField(field, value, onChange, uniqueId) {
            if (field.type === 'image') {
                return `
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">${field.label}</label>
                        <div class="flex gap-2 items-center">
                            <img src="${value || ''}" class="img-preview-mini w-12 h-12 object-cover rounded-lg shadow-sm ${!value ? 'hidden' : ''}" onerror="this.classList.add('hidden')">
                            <input type="text" id="${uniqueId}" value="${value || ''}"
                                oninput="updateDynamicField('${uniqueId}', this.value); const img=this.parentElement.querySelector('img'); if(img){img.src=this.value; img.classList.toggle('hidden', !this.value);}"
                                class="form-input w-full text-xs font-mono bg-white">
                            <label class="cursor-pointer bg-white border border-gray-200 rounded-xl px-4 flex items-center hover:bg-gray-50 shadow-sm transition-colors self-stretch">
                                <span class="material-symbols-outlined text-gray-400">add_photo_alternate</span>
                                <input type="file" class="hidden" accept="image/*"
                                    onchange="handleMediaUpload(this, '${uniqueId}')">
                            </label>
                        </div>
                    </div>
                `;
            } else if (field.type === 'text') {
                return `
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">${field.label}</label>
                        <input type="text" value="${value || ''}"
                            oninput="updateDynamicField('${uniqueId}', this.value)"
                            class="form-input w-full">
                    </div>
                `;
            } else if (field.type === 'textarea') {
                return `
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">${field.label}</label>
                        <textarea oninput="updateDynamicField('${uniqueId}', this.value)"
                            class="form-input w-full h-32 leading-relaxed">${value || ''}</textarea>
                    </div>
                `;
            } else if (field.type === 'list') {
                return renderListField(field, value, uniqueId);
            } else if (field.type === 'list-simple') {
                return renderSimpleList(field, value, uniqueId);
            }
            return '';
        }

        function renderSimpleList(field, items = [], uniqueId) {
            let listHtml = `<div id="list-${uniqueId}" class="space-y-2 mb-4">`;
            items.forEach((item, idx) => {
                listHtml += `
                    <div class="flex gap-2 items-center">
                        <span class="text-[10px] font-bold text-slate-300 w-4">${idx + 1}.</span>
                        <input type="text" value="${item}" oninput="updateSimpleItem('${uniqueId}', ${idx}, this.value)" class="form-input text-sm flex-1 !py-1">
                        <button onclick="removeSimpleItem('${uniqueId}', ${idx})" class="text-rose-300 hover:text-rose-500 transition-colors"><span class="material-symbols-outlined text-sm">remove_circle</span></button>
                    </div>
                 `;
            });
            listHtml += `
                <button onclick="addSimpleItem('${uniqueId}')" class="w-full py-2 border border-dashed border-indigo-100 rounded-lg text-[10px] font-bold text-indigo-400 hover:bg-indigo-50 hover:text-indigo-600 transition-all flex items-center justify-center gap-1 mt-2">
                    <span class="material-symbols-outlined text-xs">add</span> Add ${field.label} Item
                </button>
            </div>`;
            return `<div><label class="block text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">${field.label}</label>${listHtml}</div>`;
        }


        function renderListField(field, items = [], uniqueId) {
            let listHtml = `<div id="list-${uniqueId}" class="space-y-4">`;
            items.forEach((item, idx) => {
                listHtml += `
                    <div class="flex flex-col gap-3 p-4 rounded-xl bg-slate-50 border border-slate-100 relative group/item">
                        <div class="absolute top-2 right-2">
                             <button onclick="removeDynamicItem('${uniqueId}', ${idx})" class="text-rose-300 hover:text-rose-600 transition-colors">
                                <span class="material-symbols-outlined text-sm">remove_circle</span>
                            </button>
                        </div>
                        ${renderItemFields(field.itemType, item, uniqueId, idx)}
                    </div>
                `;
            });

            listHtml += `
                <button onclick="addDynamicItem('${uniqueId}', '${field.itemType}')" class="w-full py-3 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 hover:border-indigo-300 hover:text-indigo-600 hover:bg-indigo-50 transition-all flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined text-sm">add_circle</span> Add Item
                </button>
            </div>`;
            return `<div><label class="block text-sm font-bold text-gray-700 mb-2">${field.label}</label>${listHtml}</div>`;
        }

        function renderItemFields(itemType, item, uniqueId, idx) {
            if (itemType === 'song') {
                return `
                    <div class="grid grid-cols-1 gap-3">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" placeholder="Song Title" value="${item.songTitle || ''}" oninput="updateDynamicItem('${uniqueId}', ${idx}, 'songTitle', this.value)" class="form-input text-sm">
                            <input type="text" placeholder="Artist" value="${item.artist || ''}" oninput="updateDynamicItem('${uniqueId}', ${idx}, 'artist', this.value)" class="form-input text-sm">
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-3">
                            <label class="block text-xs font-bold text-blue-900 mb-2">ðŸŽµ Audio File (MP3)</label>
                            <div class="flex gap-2">
                                <input type="text" id="audio-${uniqueId}-${idx}" placeholder="URL or assets/path.mp3" value="${item.audioSrc || ''}" oninput="updateDynamicItem('${uniqueId}', ${idx}, 'audioSrc', this.value)" class="form-input text-xs flex-1 font-mono bg-white">
                                <label class="cursor-pointer bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg flex items-center gap-1 transition-colors shadow-sm">
                                    <span class="material-symbols-outlined text-base">upload</span>
                                    <span class="text-xs font-medium hidden sm:inline">Upload</span>
                                    <input type="file" class="hidden" accept="audio/mpeg,audio/mp3,audio/wav" onchange="handleMediaUpload(this, 'audio-${uniqueId}-${idx}')">
                                </label>
                            </div>
                            <p class="text-[10px] text-blue-600 mt-1">ðŸ’¡ Click Upload to select MP3 from computer</p>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-xl p-3">
                            <label class="block text-xs font-bold text-purple-900 mb-2">ðŸ–¼ï¸ Cover Image</label>
                            <div class="flex gap-2 items-center">
                                <img src="${item.coverSrc || ''}" class="img-preview-mini w-12 h-12 object-cover rounded-lg shadow-sm ${!item.coverSrc ? 'hidden' : ''}" onerror="this.classList.add('hidden')">
                                <input type="text" id="cover-${uniqueId}-${idx}" placeholder="URL or assets/path.jpg" value="${item.coverSrc || ''}" 
                                    oninput="updateDynamicItem('${uniqueId}', ${idx}, 'coverSrc', this.value); const img=this.parentElement.querySelector('img'); img.src=this.value; img.classList.toggle('hidden', !this.value);" 
                                    class="form-input text-xs flex-1 font-mono bg-white">
                                <label class="cursor-pointer bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg flex items-center gap-1 transition-colors shadow-sm">
                                    <span class="material-symbols-outlined text-base">image</span>
                                    <span class="text-xs font-medium hidden sm:inline">Upload</span>
                                    <input type="file" class="hidden" accept="image/*" onchange="handleMediaUpload(this, 'cover-${uniqueId}-${idx}')">
                                </label>
                            </div>
                        </div>
                        <textarea placeholder="Lyrics or notes..." oninput="updateDynamicItem('${uniqueId}', ${idx}, 'lyrics', this.value)" class="form-input text-sm h-20 resize-none">${item.lyrics || ''}</textarea>
                    </div>
                 `;
            } else if (itemType === 'question') {
                return `
                    <div class="space-y-4">
                        <div class="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100/50">
                            <label class="block text-[10px] font-bold text-indigo-400 uppercase mb-1">Question Text</label>
                            <input type="text" placeholder="e.g. Where did we first meet?" value="${item.question || ''}" oninput="updateDynamicItem('${uniqueId}', ${idx}, 'question', this.value)" class="form-input text-sm font-bold w-full border-indigo-100">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                             ${[0, 1, 2, 3].map(i => `
                                <div class="flex items-center gap-2 group">
                                    <div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-[10px] font-bold text-slate-400 group-focus-within:bg-rose-100 group-focus-within:text-rose-500 transition-colors">${i + 1}</div>
                                    <input type="text" placeholder="Answer Option ${i + 1}" value="${item.options && item.options[i] ? item.options[i] : ''}"
                                        oninput="updateDynamicOption('${uniqueId}', ${idx}, ${i}, this.value)"
                                        class="form-input text-xs flex-1">
                                </div>
                             `).join('')}
                        </div>

                        <div class="flex flex-col md:flex-row md:items-center gap-4 pt-2">
                            <div class="flex-1">
                                <label class="block text-[9px] font-bold text-emerald-600 uppercase mb-1 px-1">Correct Answer Select</label>
                                <select onchange="updateDynamicItem('${uniqueId}', ${idx}, 'correctIndex', parseInt(this.value))" class="form-input !py-1.5 text-xs w-full bg-emerald-50 border-emerald-100">
                                    ${[0, 1, 2, 3].map(i => `<option value="${i}" ${item.correctIndex === i ? 'selected' : ''}>Option ${i + 1} is Correct</option>`).join('')}
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="block text-[9px] font-bold text-slate-400 uppercase mb-1 px-1">Correct Feedback</label>
                                <input type="text" placeholder="Correct Message" value="${item.correctMessage || ''}" oninput="updateDynamicItem('${uniqueId}', ${idx}, 'correctMessage', this.value)" class="form-input !py-1.5 text-[10px]">
                            </div>
                            <div class="flex-1">
                                <label class="block text-[9px] font-bold text-slate-400 uppercase mb-1 px-1">Wrong Feedback</label>
                                <input type="text" placeholder="Wrong Message" value="${item.wrongMessage || ''}" oninput="updateDynamicItem('${uniqueId}', ${idx}, 'wrongMessage', this.value)" class="form-input !py-1.5 text-[10px]">
                            </div>
                        </div>
                    </div>
                `;
            } else if (itemType === 'memory') {
                return `
                    <div class="space-y-3">
                        <select onchange="updateDynamicItem('${uniqueId}', ${idx}, 'type', this.value); renderPages();" class="form-input text-sm font-medium">
                            <option value="image" ${item.type === 'image' ? 'selected' : ''}>ðŸ“· Image</option>
                            <option value="video" ${item.type === 'video' ? 'selected' : ''}>ðŸŽ¬ Video</option>
                        </select>
                        <div class="bg-green-50 border border-green-200 rounded-xl p-3">
                            <label class="block text-xs font-bold text-green-900 mb-2">${item.type === 'video' ? 'ðŸŽ¬ Video File (MP4)' : 'ðŸ“· Image File'}</label>
                            <div class="flex gap-2 items-center">
                                ${item.type === 'video'
                        ? `<video src="${item.src || ''}" muted playsinline class="img-preview-mini w-16 h-16 object-cover rounded-lg shadow-sm ${!item.src ? 'hidden' : ''}"></video>`
                        : `<img src="${item.src || ''}" class="img-preview-mini w-16 h-16 object-cover rounded-lg shadow-sm ${!item.src ? 'hidden' : ''}" onerror="this.classList.add('hidden')">`
                    }
                                <input type="text" id="media-${uniqueId}-${idx}" placeholder="URL or assets/path.jpg" value="${item.src || ''}" 
                                    oninput="updateDynamicItem('${uniqueId}', ${idx}, 'src', this.value); const m=this.parentElement.querySelector('.img-preview-mini'); m.src=this.value; m.classList.toggle('hidden', !this.value);" 
                                    class="form-input text-xs flex-1 font-mono bg-white">
                                <label class="cursor-pointer bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg flex items-center gap-1 transition-colors shadow-sm">
                                    <span class="material-symbols-outlined text-base">${item.type === 'video' ? 'videocam' : 'image'}</span>
                                    <span class="text-xs font-medium hidden sm:inline">Upload</span>
                                    <input type="file" class="hidden" accept="${item.type === 'video' ? 'video/mp4,video/webm' : 'image/*'}" onchange="handleMediaUpload(this, 'media-${uniqueId}-${idx}')">
                                </label>
                            </div>
                        </div>
                        <input type="text" placeholder="Caption for this memory..." value="${item.caption || ''}" oninput="updateDynamicItem('${uniqueId}', ${idx}, 'caption', this.value)" class="form-input text-sm">
                        <div class="grid grid-cols-2 gap-2">
                            <select onchange="updateDynamicItem('${uniqueId}', ${idx}, 'tape', this.value)" class="form-input text-xs">
                                <option value="washi-tape" ${item.tape === 'washi-tape' ? 'selected' : ''}>ðŸŽ€ Pink Tape</option>
                                <option value="washi-tape-gold" ${item.tape === 'washi-tape-gold' ? 'selected' : ''}>âœ¨ Gold Tape</option>
                            </select>
                            <select onchange="updateDynamicItem('${uniqueId}', ${idx}, 'rotation', this.value)" class="form-input text-xs">
                                <option value="rotate-1" ${item.rotation === 'rotate-1' ? 'selected' : ''}>Tilt Left</option>
                                <option value="rotate-2" ${item.rotation === 'rotate-2' ? 'selected' : ''}>Tilt Right</option>
                                <option value="-rotate-1" ${item.rotation === '-rotate-1' ? 'selected' : ''}>Tilt Back</option>
                            </select>
                        </div>
                    </div>
                `;
            } else if (itemType === 'location') {
                return `
                    <div class="grid grid-cols-2 gap-3">
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Marker Icon</label>
                            <select onchange="updateDynamicItem('${uniqueId}', ${idx}, 'icon', this.value)" class="form-input text-sm">
                                <option value="favorite" ${item.icon === 'favorite' || !item.icon ? 'selected' : ''}>â¤ï¸ Heart</option>
                                <option value="star" ${item.icon === 'star' ? 'selected' : ''}>â­ Star</option>
                                <option value="location_on" ${item.icon === 'location_on' ? 'selected' : ''}>ðŸ“ Location</option>
                                <option value="restaurant" ${item.icon === 'restaurant' ? 'selected' : ''}>ðŸ´ Food</option>
                                <option value="park" ${item.icon === 'park' ? 'selected' : ''}>ðŸŒ³ Park</option>
                                <option value="theater_comedy" ${item.icon === 'theater_comedy' ? 'selected' : ''}>ðŸŽ¬ Cinema</option>
                                <option value="photo_camera" ${item.icon === 'photo_camera' ? 'selected' : ''}>ðŸ“¸ Photo</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Date</label>
                            <input type="date" value="${item.date || ''}" oninput="updateDynamicItem('${uniqueId}', ${idx}, 'date', this.value)" class="form-input text-sm">
                        </div>
                        <input type="text" placeholder="Location Name" value="${item.title || ''}" oninput="updateDynamicItem('${uniqueId}', ${idx}, 'title', this.value)" class="form-input text-sm font-bold col-span-2">
                        <div class="flex gap-1 col-span-2">
                            <input type="text" placeholder="Lat" value="${item.lat || ''}" oninput="updateDynamicItem('${uniqueId}', ${idx}, 'lat', this.value)" class="form-input text-xs flex-1">
                            <input type="text" placeholder="Lng" value="${item.lng || ''}" oninput="updateDynamicItem('${uniqueId}', ${idx}, 'lng', this.value)" class="form-input text-xs flex-1">
                        </div>
                         <input type="text" placeholder="Memory Description" value="${item.memory || ''}" oninput="updateDynamicItem('${uniqueId}', ${idx}, 'memory', this.value)" class="form-input text-sm col-span-2">
                         <div class="flex gap-2 col-span-2 items-center">
                             <img src="${item.imageSrc || ''}" class="img-preview-mini w-12 h-12 object-cover rounded-lg shadow-sm ${!item.imageSrc ? 'hidden' : ''}" onerror="this.classList.add('hidden')">
                                <input type="text" id="map-img-${uniqueId}-${idx}" placeholder="URL or assets/path.jpg" value="${item.imageSrc || ''}" 
                                    oninput="updateDynamicItem('${uniqueId}', ${idx}, 'imageSrc', this.value); const img=this.parentElement.querySelector('img'); if(img){img.src=this.value; img.classList.toggle('hidden', !this.value);}" 
                                    class="form-input text-xs flex-1 font-mono bg-white">
                            <label class="cursor-pointer bg-white border border-gray-200 rounded-xl px-4 flex items-center hover:bg-gray-50 shadow-sm transition-colors self-stretch">
                                <span class="material-symbols-outlined text-gray-400">add_photo_alternate</span>
                                <input type="file" class="hidden" accept="image/*"
                                    onchange="handleMediaUpload(this, 'map-img-${uniqueId}-${idx}')">
                            </label>
                         </div>
                    </div>
                 `;
            }
            return '';
        }

        // Global Helpers exposed to window
        window.updateDynamicField = (uniqueId, value) => {
            const [pIdx, key] = uniqueId.split('-'); // p0-title
            const pageIndex = parseInt(pIdx.substring(1));
            configData.pages[pageIndex][key] = value;
            syncToPreview();
        };

        window.updateDynamicItem = (uniqueId, idx, key, value) => {
            const [pIdx, fieldKey] = uniqueId.split('-');
            const pageIndex = parseInt(pIdx.substring(1));
            configData.pages[pageIndex][fieldKey][idx][key] = value;
            syncToPreview();
        };

        window.updateSimpleItem = (uniqueId, idx, value) => {
            const [pIdx, fieldKey] = uniqueId.split('-');
            const pageIndex = parseInt(pIdx.substring(1));
            configData.pages[pageIndex][fieldKey][idx] = value;
            syncToPreview();
        };

        window.addSimpleItem = (uniqueId) => {
            const [pIdx, fieldKey] = uniqueId.split('-');
            const pageIndex = parseInt(pIdx.substring(1));
            if (!configData.pages[pageIndex][fieldKey]) configData.pages[pageIndex][fieldKey] = [];
            configData.pages[pageIndex][fieldKey].push("");
            renderPages();
            syncToPreview();
        };

        window.removeSimpleItem = (uniqueId, idx) => {
            const [pIdx, fieldKey] = uniqueId.split('-');
            const pageIndex = parseInt(pIdx.substring(1));
            configData.pages[pageIndex][fieldKey].splice(idx, 1);
            renderPages();
            syncToPreview();
        };

        window.addDynamicItem = (uniqueId, itemType) => {
            const [pIdx, fieldKey] = uniqueId.split('-');
            const pageIndex = parseInt(pIdx.substring(1));
            let newItem = {};
            if (itemType === 'song') newItem = { songTitle: '', artist: '', audioSrc: '', coverSrc: '', lyrics: '' };
            else if (itemType === 'question') newItem = { question: '', options: ['', '', '', ''], correctIndex: 0, correctMessage: 'Correct!', wrongMessage: 'Wrong!' };
            else if (itemType === 'memory') newItem = { type: 'image', src: '', caption: '', tape: 'washi-tape', rotation: 'rotate-1' };
            else if (itemType === 'location') newItem = { lat: '', lng: '', title: '', memory: '', date: '', imageSrc: '', icon: 'favorite' };

            if (!configData.pages[pageIndex][fieldKey]) configData.pages[pageIndex][fieldKey] = [];
            configData.pages[pageIndex][fieldKey].push(newItem);
            renderPages();
            syncToPreview();
        };

        window.removeDynamicItem = (uniqueId, idx) => {
            const [pIdx, fieldKey] = uniqueId.split('-');
            const pageIndex = parseInt(pIdx.substring(1));
            configData.pages[pageIndex][fieldKey].splice(idx, 1);
            renderPages();
            syncToPreview();
        };

        // Logic Helpers
        window.openPagePicker = () => {
            document.getElementById('picker-modal').classList.remove('hidden');
            document.getElementById('picker-modal').classList.add('flex');
            renderPickerGrid();
        };

        window.closePicker = () => {
            document.getElementById('picker-modal').classList.add('hidden');
            document.getElementById('picker-modal').classList.remove('flex');
        };

        window.renderPickerGrid = () => {
            const grid = document.getElementById('page-type-selector');
            grid.innerHTML = Object.keys(PAGE_TYPES).map(key => `
                <div onclick="confirmPageAdd('${key}')" class="p-4 border border-slate-200 rounded-xl hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer text-center transition-all group">
                    <span class="material-symbols-outlined text-3xl text-slate-400 group-hover:text-indigo-600 mb-2">${PAGE_TYPES[key].icon}</span>
                    <h4 class="text-xs font-bold uppercase text-slate-600 group-hover:text-indigo-700">${key.replace('-', ' ')}</h4>
                </div>
             `).join('');
        };

        window.confirmPageAdd = (type) => {
            const newItem = { type: type };
            // Init default arrays
            if (type === 'music-section') newItem.music = [];
            if (type === 'quiz-section') newItem.questions = [];
            if (type === 'gallery-section') newItem.memories = [];

            configData.pages.push(newItem);
            renderPages();
            syncToPreview();
            closePicker();
        };

        window.removePage = (index) => {
            if (confirm('Remove this section?')) {
                configData.pages.splice(index, 1);
                renderPages();
                syncToPreview();
            }
        };

        window.movePage = (index, direction) => {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= configData.pages.length) return;
            const item = configData.pages.splice(index, 1)[0];
            configData.pages.splice(newIndex, 0, item);
            renderPages();
            syncToPreview();
        };

        window.updateDynamicOption = (uniqueId, idx, optIdx, val) => {
            const [pIdx, fieldKey] = uniqueId.split('-');
            const pageIndex = parseInt(pIdx.substring(1));
            if (!configData.pages[pageIndex][fieldKey][idx].options) configData.pages[pageIndex][fieldKey][idx].options = ["", "", "", ""];
            configData.pages[pageIndex][fieldKey][idx].options[optIdx] = val;
            syncToPreview();
        };


        // --- CONFIG GENERATOR ENGINE ---
        function getConfig() {
            const val = (id, fallback = "") => {
                const el = document.getElementById(id);
                if (!el) {
                    console.warn(`[Config] Element #${id} not found.`);
                    return fallback;
                }
                return el.value;
            };

            const safeList = (id) => {
                const el = document.getElementById(id);
                return el ? Array.from(el.children) : [];
            };

            // --- EXTRACT DYNAMIC DATA ---

            // Helpers to find sections
            const findPage = (type) => configData.pages.find(p => p.type === type);

            // Music
            const musicPage = findPage('music-section');
            const musicData = musicPage && musicPage.music ? musicPage.music : [];
            const musicSectionTitle = musicPage ? musicPage.songTitle : "Our Playlist";

            // Quiz
            const quizPage = findPage('quiz-section');
            const quizData = quizPage && quizPage.questions ? quizPage.questions : [];

            // Gallery
            const galleryPage = findPage('gallery-section');
            const galleryData = galleryPage && galleryPage.memories ? galleryPage.memories : [];

            // Map
            const mapPage = findPage('map-section');
            const mapData = {
                title: mapPage ? (mapPage.title || "") : (val('map_title') || "The Atlas of Us"),
                description: mapPage ? (mapPage.description || "") : (val('map_desc') || "A cartography of our shared path."),
                locations: mapPage && mapPage.locations ? mapPage.locations.map(l => ({
                    coordinates: [parseFloat(l.lat) || 0, parseFloat(l.lng) || 0],
                    title: l.title || "",
                    memory: l.memory || "",
                    date: l.date || "",
                    imageSrc: l.imageSrc || "",
                    icon: l.icon || "favorite"
                })) : []
            };

            // Letter
            const letterPage = findPage('letter-section');
            const letterData = {
                recipientName: letterPage ? letterPage.recipient : (val('let_rec') || ""),
                message: letterPage ? letterPage.message : (val('let_msg') || ""),
                signature: letterPage ? letterPage.signature : (val('let_sig') || "")
            };

            // Lock
            const lockPage = findPage('lock-section');
            const lockData = {
                initials: lockPage ? lockPage.initials : (val('lock_init') || ""),
                instruction: lockPage ? lockPage.instruction : (val('lock_instr') || ""),
                finalMessage: lockPage ? lockPage.finalMessage : (val('lock_msg') || "")
            };

            // Wrapped
            const wrappedPage = findPage('wrapped-section');
            const wrappedData = {
                topPlacesLabel: wrappedPage ? (wrappedPage.topPlacesLabel || "Top Places") : "Top Places",
                topPlaces: (wrappedPage && wrappedPage.topPlaces) ? wrappedPage.topPlaces : [],
                coreMemoriesLabel: wrappedPage ? (wrappedPage.coreMemoriesLabel || "Core Memories") : "Core Memories",
                coreMemories: (wrappedPage && wrappedPage.coreMemories) ? wrappedPage.coreMemories : [],

                HoursTogetherLabel: wrappedPage ? (wrappedPage.HoursTogetherLabel || "Hours Together") : "Hours Together",
                HoursTogether: wrappedPage ? (wrappedPage.HoursTogether || "") : "",
                vibeLabel: wrappedPage ? (wrappedPage.vibeLabel || "Our Vibe") : "Our Vibe",
                vibe: wrappedPage ? (wrappedPage.vibe || "") : "",
                imageSrc: wrappedPage ? (wrappedPage.imageSrc || "") : ""
            };


            // ISO Format Date Converter
            let rawTargetDate = val('count_date');
            let targetDate = rawTargetDate;
            try {
                if (rawTargetDate) {
                    const d = new Date(rawTargetDate);
                    if (!isNaN(d.getTime())) {
                        // Use a safer format: YYYY-MM-DDTHH:mm:ss+07:00
                        targetDate = rawTargetDate + ":00+07:00";
                    }
                }
            } catch (e) {
                console.warn("[Admin] Date conversion failed:", e);
            }

            // Invitation
            const invitePage = findPage('invitation-section');
            const inviteData = {
                title: invitePage ? invitePage.title : "Will you be my Valentine?",
                subtitle: invitePage ? invitePage.subtitle : "I have a special question...",
                yesText: invitePage ? invitePage.yesText : "Yes!",
                noText: invitePage ? invitePage.noText : "No"
            };

            return {
                theme: {
                    backgroundImage: val('theme_bg') || '',
                    backgroundColor: val('theme_color') || '#F5E6D3',
                    fontDisplay: val('theme_font_display'),
                    fontSans: val('theme_font_sans'),
                    particles: val('theme_particles')
                },
                navigation: {
                    showPageIndicator: document.getElementById('show_indicator') ? document.getElementById('show_indicator').checked : true,
                    enableSwipe: document.getElementById('enable_swipe') ? document.getElementById('enable_swipe').checked : true
                },
                seo: {
                    title: val('seo_title'),
                    description: val('seo_desc'),
                    image: val('seo_image')
                },
                login: {
                    password: val('password'),
                    errorMessage: "Incorrect password, try again!",
                    collectionText: val('collectionText'),
                    title: val('p1_title'),
                    instruction: val('p1_instr'),
                    placeholder: "*your secret word...*"
                },
                countdown: {
                    targetDate: targetDate,
                    finishMessage: val('count_finish'),
                    finishLabel: "Happy Valentine's Day!"
                },
                wrapped: wrappedData,
                greeting: {
                    title: val('greet_title'),
                    message: val('greet_msg'),
                    imageSrc: val('greet_img'),
                    footerText: val('greet_footer')
                },
                quiz: { questions: quizData },
                invitation: inviteData,
                music: musicData,
                musicSectionTitle: musicSectionTitle,
                gallery: {
                    title: galleryPage ? galleryPage.title : (val('gal_title') || "Gallery"),
                    subtitle: galleryPage ? galleryPage.subtitle : (val('gal_sub') || ""),
                    memories: galleryData
                },
                map: mapData,
                letter: letterData,
                lock: lockData
            };
        }



        // --- SAFE INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Init Dynamic Engine (Migration Defaults)
            if (configData.pages.length === 0) {
                if (!loadFromLocalStorage()) {
                    // 1. Music (PAGE 3)
                    configData.pages.push({
                        type: 'music-section',
                        songTitle: 'Our Playlist',
                        music: [
                            { songTitle: "Selfless", artist: "The Strokes", audioSrc: "assets/song1.dat", coverSrc: "assets/cover1.jpg", lyrics: "Life is too short..." },
                            { songTitle: "Ivy", artist: "Frank Ocean", audioSrc: "assets/song2.dat", coverSrc: "assets/cover2.jpg", lyrics: "I thought that I was dreaming..." },
                            { songTitle: "Song 3", artist: "Unknown", audioSrc: "assets/song3.dat", coverSrc: "", lyrics: "" }
                        ]
                    });
                    // 2. Wrapped (PAGE 4)
                    configData.pages.push({
                        type: 'wrapped-section',
                        vibeLabel: "Our Vibe", vibe: "Bonnie & Clyde",
                        HoursTogetherLabel: "Minutes Together", HoursTogether: "525,600",
                        imageSrc: "assets/images/photo2.jpg",
                        topPlaces: ["The Sunset Pier", "Corner Bakery", "Botanical Garden"],
                        coreMemories: ["The Rainy Hike", "First Road Trip", "Cooking Fail"]
                    });
                    // 3. Quiz
                    configData.pages.push({
                        type: 'quiz-section',
                        title: 'Personalized Trivia',
                        questions: [
                            { question: "Where was our very first date?", options: ["Starbucks KIP", "Cinema XXI", "Parks & Rec", "Dinner at McD"], correctIndex: 0, correctMessage: "You remembered! â¤ï¸", wrongMessage: "Nope!" },
                            { question: "What is my favorite color on you?", options: ["Rose Pink", "Soft Blue", "Sage Green", "Classic Black"], correctIndex: 2, correctMessage: "Yes!", wrongMessage: "Listen closely..." }
                        ]
                    });
                    // 4. Gallery
                    configData.pages.push({
                        type: 'gallery-section',
                        title: 'Scratch Gallery',
                        subtitle: 'Scratch to reveal a piece of my heart',
                        memories: [
                            { type: 'image', src: 'assets/images/photo2.jpg', caption: 'Our first coffee', tape: 'washi-tape-gold', rotation: 'rotate-2' },
                            { type: 'image', src: 'assets/images/photo3.jpg', caption: 'Golden hour', tape: 'washi-tape', rotation: 'rotate-1' }
                        ]
                    });
                    // 5. Map
                    configData.pages.push({
                        type: 'map-section',
                        title: 'The Atlas of Us',
                        description: 'A cartography of the moments that defined our story. Every pin is a heartbeat, every line a path we walked together.',
                        locations: [
                            { lat: -6.24625885, lng: 106.9913550, title: "Where we first met", memory: "The air was sweet...", date: "2020-01-20" }
                        ]
                    });
                    // 6. Letter
                    configData.pages.push({
                        type: 'letter-section',
                        recipient: 'Dearest Love',
                        message: 'I find myself sitting here...',
                        signature: 'Your Favorite Person'
                    });
                    // 7. Lock
                    configData.pages.push({
                        type: 'lock-section',
                        initials: 'A + B',
                        instruction: 'Click to lock our love forever...',
                        finalMessage: 'Safely locked in my heart. Always.'
                    });
                }
            }
            renderPages();
            syncToPreview();
        });

        function togglePreview() {
            const sidebar = document.querySelector('.sticky-sidebar');
            if (sidebar) {
                // Desktop: Toggle visibility
                if (window.innerWidth >= 1024) {
                    sidebar.classList.toggle('force-hidden');
                } else {
                    // Mobile: Toggle Modal
                    sidebar.classList.toggle('mobile-open');
                    if (sidebar.classList.contains('mobile-open')) syncToPreview();
                }
            }
        }

        function updateStatus(status, color) {
            const el = document.getElementById('syncStatus');
            if (!el) return;
            el.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-${color}-500"></span> ${status}`;
            el.className = `inline-flex items-center gap-1 px-2 py-1 rounded-full bg-${color}-50 text-[10px] font-sans font-bold text-${color}-600 uppercase tracking-tighter transition-all`;
        }

        // --- PERSISTENCE ENGINE ---
        const LS_KEY = 'valentine_admin_data';

        // --- TELEGRAM CONFIG (Developer: Set these!) ---
        const TELEGRAM_BOT_TOKEN = '7954042042:AAF-a7XQn0XufnODKzJn1bQKXvt9Slmbixs';
        const TELEGRAM_CHAT_ID = '972162604';

        function saveToLocalStorage() {
            clearTimeout(window._lsTimeout);
            window._lsTimeout = setTimeout(() => {
                const config = getConfig();
                const data = {
                    config: config,
                    pages: configData.pages // Save the dynamic pages structure
                };
                localStorage.setItem(LS_KEY, JSON.stringify(data));
                updateStatus('Saved locally', 'blue');
            }, 500);
        }

        function repairData(data) {
            if (!data || !data.pages) return data;
            data.pages.forEach(p => {
                if (p.type === 'music-section') {
                    if (!p.music) p.music = [];
                    if (p.music.length === 0) {
                        p.music = [
                            { songTitle: "Selfless", artist: "The Strokes", audioSrc: "assets/song1.dat", coverSrc: "assets/cover1.jpg", lyrics: "Life is too short..." },
                            { songTitle: "Ivy", artist: "Frank Ocean", audioSrc: "assets/song2.dat", coverSrc: "assets/cover2.jpg", lyrics: "I thought that I was dreaming..." },
                            { songTitle: "Song 3", artist: "Unknown", audioSrc: "assets/song3.dat", coverSrc: "", lyrics: "" }
                        ];
                    }
                    p.music.forEach(s => {
                        if (s.s && !s.songTitle) s.songTitle = s.s;
                        if (s.a && !s.artist) s.artist = s.a;
                        if (s.src && !s.audioSrc) s.audioSrc = s.src;
                    });
                }
            });
            return data;
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem(LS_KEY);
            if (!saved) return false;
            try {
                const rawData = JSON.parse(saved);
                const data = repairData(rawData);
                if (data.pages) configData.pages = data.pages;

                // Restoring standard inputs
                setTimeout(() => {
                    const config = data.config;
                    if (config.theme) {
                        setVal('theme_bg', config.theme.backgroundImage);
                        setVal('theme_color', config.theme.backgroundColor);
                        setVal('theme_font_display', config.theme.fontDisplay);
                        setVal('theme_font_sans', config.theme.fontSans);
                        setVal('theme_particles', config.theme.particles);
                    }
                    if (config.seo) {
                        setVal('seo_title', config.seo.title);
                        setVal('seo_desc', config.seo.description);
                        setVal('seo_image', config.seo.image);
                    }
                    if (config.login) {
                        setVal('password', config.login.password);
                        setVal('collectionText', config.login.collectionText);
                        setVal('p1_title', config.login.title);
                        setVal('p1_instr', config.login.instruction);
                    }
                    if (config.countdown) {
                        // ISO to local datetime-local
                        if (config.countdown.targetDate) {
                            const d = new Date(config.countdown.targetDate);
                            const localTime = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                            setVal('count_date', localTime);
                        }
                        setVal('count_finish', config.countdown.finishMessage);
                    }
                    if (config.greeting) {
                        setVal('greet_title', config.greeting.title);
                        setVal('greet_msg', config.greeting.message);
                        setVal('greet_img', config.greeting.imageSrc);
                        setVal('greet_footer', config.greeting.footerText);
                    }

                    renderPages();
                    syncToPreview();
                }, 100);
                return true;
            } catch (e) {
                console.error("Load fail", e);
                return false;
            }
        }

        function setVal(id, val) {
            const el = document.getElementById(id);
            if (el) el.value = val || "";
        }

        function syncToPreview() {
            clearTimeout(syncTimeout);
            saveToLocalStorage(); // Auto-save on every sync
            syncTimeout = setTimeout(() => {
                try {
                    const config = getConfig(); // Mengambil data dari form admin
                    const iframe = document.getElementById('livePreview');

                    if (iframe && iframe.contentWindow) {
                        // MENGIRIM PESAN KE IFRAME
                        iframe.contentWindow.postMessage({
                            type: 'UPDATE_CONFIG',
                            config: config
                        }, '*');
                        updateStatus('Synced', 'green');
                    }
                } catch (e) {
                    console.error("Gagal sinkronisasi:", e);
                }
            }, 100); // Delay 100ms agar tidak terlalu berat saat mengetik
        }

        // Listen for messages from preview
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'PREVIEW_READY') {
                updateStatus('Connected', 'emerald');
                console.log("[Admin] Preview ready handshake received.");
                syncToPreview();
            }
            if (event.data && event.data.type === 'LOG') {
                console.log("[Preview Log]", event.data.message);
            }
        });

        // Attach listeners to all inputs
        document.getElementById('configForm').addEventListener('input', syncToPreview);
        document.getElementById('configForm').addEventListener('change', syncToPreview);

        function generateCode() {
            const config = getConfig();
            // Remove pages from the final output but keep it for admin re-use if they want
            // However, script.js doesn't need it, so we'll omit it to simplify for the user
            const finalConfig = { ...config };
            delete finalConfig.pages;

            const codeOutput = "var CONFIG = " + JSON.stringify(finalConfig, null, 4) + ";";
            document.getElementById('outputCode').value = codeOutput;
            document.getElementById('resultModal').classList.remove('hidden');
        }

        function copyCode() {
            const textarea = document.getElementById("outputCode");
            textarea.select();
            document.execCommand("copy");
            const btn = document.querySelector('[onclick="copyCode()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="material-symbols-outlined">done_all</span> Copied!';
            btn.classList.replace('bg-emerald-500', 'bg-emerald-600');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.replace('bg-emerald-600', 'bg-emerald-500');
            }, 2000);
        }

        async function submitToAdmin() {
            if (TELEGRAM_BOT_TOKEN.startsWith('PASTE_')) {
                alert("Developer Note: Mohon atur TELEGRAM_BOT_TOKEN dan CHAT_ID di dalam file admin.html terlebih dahulu.");
                return;
            }

            const config = getConfig();
            const configCode = "var CONFIG = " + JSON.stringify(config, null, 4) + ";";

            const btn = document.querySelector('[onclick="submitToAdmin()"]');
            const originalContent = btn.innerHTML;

            if (!confirm("Kirim konfigurasi data.js ke Telegram Admin?")) return;

            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined animate-spin">sync</span> Mengirim File...';

            try {
                // 1. Persiapkan File data.js (Blob)
                const blob = new Blob([configCode], { type: 'text/javascript' });
                const formData = new FormData();
                formData.append('chat_id', TELEGRAM_CHAT_ID);
                formData.append('document', blob, 'data.js');
                formData.append('caption', "âœ¨ Konfigurasi Valentine baru telah dibuat!");

                // 2. Kirim ke Telegram API
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    btn.innerHTML = '<span class="material-symbols-outlined">verified</span> BERHASIL!';
                    btn.className = btn.className.replace('bg-rose-600', 'bg-emerald-500');
                    alert("Berhasil dikirim ke Admin!");
                    localStorage.removeItem(LS_KEY);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.description || "Gagal mengirim");
                }
            } catch (err) {
                btn.disabled = false;
                btn.innerHTML = originalContent;
                alert("Gagal mengirim file: " + err.message);
            }
        }
    </script>
    <!-- PAGE PICKER MODAL -->
    <div id="picker-modal"
        class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] items-center justify-center p-4 animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[80vh] flex flex-col p-8 shadow-2xl relative">
            <button onclick="closePicker()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <span class="material-symbols-outlined">close</span>
            </button>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Build Your Story</h2>
            <p class="text-gray-500 text-sm mb-6">Choose a section to add to your journey.</p>

            <div id="page-type-selector" class="grid grid-cols-2 sm:grid-cols-3 gap-4 overflow-y-auto">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>
</body>

</html>